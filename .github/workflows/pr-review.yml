name: PR Code Review Bot

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  review:
    # fork에서만 동작 (원본 Samsung/escargot에서는 안 돌도록)
    if: github.repository == '2Jaeheon/escargot'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get PR diff
        id: diff
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          REPO=${{ github.repository }}
          echo "Getting diff for PR #$PR_NUMBER in $REPO"
          curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
               -H "Accept: application/vnd.github.v3.diff" \
               https://api.github.com/repos/$REPO/pulls/$PR_NUMBER > pr.diff
          echo "Diff saved to pr.diff"
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq
      - name: Send diff to local review bot (Ollama)
        id: ollama
        run: |
          echo "Sending diff to Ollama server at ${{ secrets.LOCAL_REVIEW_URL }}"
          REVIEW=$(curl -s ${{ secrets.LOCAL_REVIEW_URL }} \
            -H "Content-Type: application/json" \
            -d "{\"diff\": \"$(cat pr.diff | sed 's/\"/\\\"/g')\"}")
          # Save review for later steps
          echo "$REVIEW" > review.txt
          echo "review<<EOF" >> $GITHUB_OUTPUT
          cat review.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Debug review content
        run: |
          echo "=== REVIEW CONTENT START ==="
          cat review.txt || true
          echo "=== REVIEW CONTENT END ==="

      - name: Post review comment to PR
        run: |
          if [ ! -s review.txt ]; then
            echo "No review content. Skipping comment."
            exit 0
          fi

          PR_NUMBER=${{ github.event.pull_request.number }}
          REPO=${{ github.repository }}

          # Base64 encode review content to ensure JSON safety
          COMMENT_B64=$(base64 -w 0 review.txt)

          echo "Posting review comment to PR #$PR_NUMBER"
          curl -s -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{\"body\": \"$(echo $COMMENT_B64 | base64 --decode)\"}" \
            https://api.github.com/repos/$REPO/issues/$PR_NUMBER/comments